@if (selectedOrder(); as order) {
<mat-card>
  <h2>{{ 'order.editTitle' | translate:{ id: orderForm()?.get('id')?.value } }}</h2>

  <form [formGroup]="orderForm()!">
    <!-- Customer Name -->
    <mat-form-field appearance="fill" class="field">
      <mat-label>{{ 'order.client' | translate }}</mat-label>
      <input matInput formControlName="customerName" />
      <mat-error *ngIf="orderForm()?.get('customerName')?.hasError('required') && orderForm()?.touched">
        {{ 'order.clientRequired' | translate }}
      </mat-error>
    </mat-form-field>

    <!-- Status Select -->
    <mat-form-field appearance="fill" class="field">
      <mat-label>{{ 'order.status' | translate }}</mat-label>
      <mat-select formControlName="status">
        @for (s of statuses; track s.value) {
        <mat-option [value]="s.value">
          {{ ('order.statusValues.' + s.value) | translate }}
        </mat-option>
        }
      </mat-select>
      <mat-error *ngIf="orderForm()?.get('status')?.hasError('required') && orderForm()?.touched">
        {{ 'order.statusRequired' | translate }}
      </mat-error>
    </mat-form-field>

    <!-- Items -->
    <h3>{{ 'order.items' | translate }}</h3>

    <div formArrayName="products" class="item-list">
      @for (itemGroup of productsFormArray.controls; track itemGroup; let i = $index) {
      <div [formGroupName]="i" class="item-row">
        <!-- Product Item Select -->
        <mat-form-field appearance="fill" class="product-field">
          <mat-label>{{ 'order.product' | translate }}</mat-label>
          <mat-select formControlName="productItem" (selectionChange)="onProductChange($event.value, i)"
            [compareWith]="compareProducts">
            @for (product of products(); track product.id) {
            <mat-option [value]="product">
              {{ product.title }}
            </mat-option>
            }
          </mat-select>
          <mat-error *ngIf="itemGroup.get('productItem')?.hasError('required') && itemGroup.touched">
            {{ 'order.required' | translate }}
          </mat-error>
        </mat-form-field>

        <!-- Quantity -->
        <mat-form-field appearance="fill" class="qty-field">
          <mat-label>{{ 'order.quantity' | translate }}</mat-label>
          <input matInput type="number" formControlName="qty" />
          <mat-error *ngIf="itemGroup.get('qty')?.hasError('required') && itemGroup.touched">
            {{ 'order.required' | translate }}
          </mat-error>
          <mat-error *ngIf="itemGroup.get('qty')?.hasError('min') && itemGroup.touched">
            {{ 'order.quantityMin' | translate }}
          </mat-error>
        </mat-form-field>

        <!-- Price -->
        <mat-form-field appearance="fill" class="price-field">
          <mat-label>{{ 'order.price' | translate }}</mat-label>
          <input matInput type="number" formControlName="price" />
          <mat-error *ngIf="itemGroup.get('price')?.hasError('required') && itemGroup.touched">
            {{ 'order.required' | translate }}
          </mat-error>
          <mat-error *ngIf="itemGroup.get('price')?.hasError('min') && itemGroup.touched">
            {{ 'order.priceMin' | translate }}
          </mat-error>
        </mat-form-field>

        <!-- Remove Button -->
        <button mat-stroked-button color="warn" type="button" (click)="removeItem(i)">
          {{ 'order.actions.remove' | translate }}
        </button>
      </div>
      }
    </div>

    <!-- Add Item -->
    <button mat-stroked-button color="primary" type="button" (click)="addItem()">
      {{ 'order.actions.addItem' | translate }}
    </button>

    <!-- Total -->
    <h3 class="total">
      {{ 'order.total' | translate }} {{ total() | currency }}
    </h3>

    <!-- Actions -->
    <div class="actions">
      <button mat-raised-button color="primary" type="button" (click)="save()">
        {{ 'order.actions.save' | translate }}
      </button>
      <button mat-raised-button color="warn" type="button" (click)="delete()">
        {{ 'order.actions.delete' | translate }}
      </button>
      <button mat-button type="button" (click)="cancel()">
        {{ 'order.actions.cancel' | translate }}
      </button>
    </div>
  </form>
</mat-card>
} @else {
<mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
}